# app/api/entities/company_entity.rb
module Entities
  class CompanyEntity < Grape::Entity
    expose :id
    expose :name
    expose :tax_id
    expose :email
    expose :phone
    expose :address
    expose :city
    expose :country
    expose :is_active
    expose :created_at
    expose :updated_at

    # Estadísticas opcionales
    expose :stats, if: ->(instance, options) { options[:include_stats] } do
      expose :total_vehicles do |instance|
        instance.vehicles.count
      end

      expose :active_vehicles do |instance|
        instance.vehicles.where(is_active: true).count
      end

      expose :telemetry_credentials_count do |instance|
        instance.telemetry_credentials.count
      end

      expose :active_telemetry_credentials do |instance|
        instance.telemetry_credentials.active.count
      end
    end
  end
end
# app/api/entities/electric_charge_entity.rb
module Entities
  class ElectricChargeEntity < Grape::Entity
    expose :id
    expose :vehicle_id
    expose :external_id
    expose :provider_name
    expose :start_time
    expose :duration_minutes
    expose :energy_consumed_kwh
    expose :start_soc_percent
    expose :end_soc_percent
    expose :charge_type
    expose :charge_is_estimated
    expose :odometer_km
    expose :peak_power_kw
    expose :measured_charger_energy_in_kwh
    expose :measured_battery_energy_in_kwh
    expose :created_at
    expose :updated_at

    # Ubicación
    expose :location, if: ->(instance, options) { instance.has_location? } do
      expose :latitude do |instance|
        instance.location_lat
      end
      expose :longitude do |instance|
        instance.location_lng
      end
      expose :coordinates do |instance|
        instance.coordinates
      end
    end

    # Métricas calculadas
    expose :metrics, if: ->(instance, options) { options[:include_calculations] } do
      expose :soc_gained_percent do |instance|
        instance.soc_gained_percent
      end
      expose :charging_efficiency_percent do |instance|
        instance.charging_efficiency_percent
      end
      expose :duration_hours do |instance|
        instance.duration_hours
      end
      expose :average_power_kw do |instance|
        instance.average_power_kw
      end
    end

    # Anomalías
    expose :anomalies, if: ->(instance, options) { options[:include_anomalies] } do
      expose :low_efficiency do |instance|
        instance.low_efficiency?
      end
    end

    # Tipo de carga
    expose :is_fast_charge do |instance|
      instance.fast_charge?
    end

    expose :is_slow_charge do |instance|
      instance.slow_charge?
    end

    # Datos raw solo para admins
    expose :raw_data, if: ->(instance, options) { options[:admin_view] }

    # Relaciones
    expose :vehicle, using: VehicleEntity, if: ->(instance, options) { options[:include_vehicle] }
  end
end
# app/api/entities/refuel_entity.rb
module Entities
  class RefuelEntity < Grape::Entity
    expose :id
    expose :vehicle_id
    expose :external_id
    expose :provider_name
    expose :refuel_date
    expose :volume_liters
    expose :cost
    expose :currency_code
    expose :odometer_km
    expose :tank_capacity_liters
    expose :distance_since_last_refuel_km
    expose :confidence_level
    expose :product_type
    expose :created_at
    expose :updated_at

    # Ubicación
    expose :location, if: ->(instance, options) { instance.has_location? } do
      expose :latitude do |instance|
        instance.location_lat
      end
      expose :longitude do |instance|
        instance.location_lng
      end
      expose :coordinates do |instance|
        instance.coordinates
      end
    end

    # Métricas calculadas
    expose :consumption_per_100km, if: ->(instance, options) { options[:include_calculations] }

    # Anomalías
    expose :anomalies, if: ->(instance, options) { options[:include_anomalies] } do
      expose :exceeds_tank_capacity do |instance|
        instance.exceeds_tank_capacity?
      end
      expose :suspicious_location do |instance|
        instance.suspicious_location?
      end
    end

    # Datos raw solo para admins
    expose :raw_data, if: ->(instance, options) { options[:admin_view] }

    # Relaciones
    expose :vehicle, using: VehicleEntity, if: ->(instance, options) { options[:include_vehicle] }
  end
end
# app/api/entities/telemetry_credential_entity.rb
module Entities
  class TelemetryCredentialEntity < Grape::Entity
    expose :id
    expose :company_id
    expose :telemetry_provider_id
    expose :is_active
    expose :last_sync_at
    expose :last_successful_sync_at
    expose :created_at
    expose :updated_at

    # Relaciones
    expose :telemetry_provider, using: TelemetryProviderEntity, if: ->(instance, options) { options[:include_provider] }

    # Exponer schema de configuración del proveedor (para que frontend sepa qué campos mostrar)
    expose :configuration_schema, if: ->(instance, options) { options[:include_config_schema] } do |instance|
      instance.telemetry_provider.configuration_schema
    end

    # Mostrar qué campos están configurados (sin exponer valores)
    expose :configured_fields, if: ->(instance, options) { options[:include_config_schema] } do |instance|
      credentials = instance.credentials_hash
      schema_fields = instance.telemetry_provider.configuration_schema.fetch("fields", [])

      schema_fields.map do |field|
        {
          name: field["name"],
          label: field["label"],
          configured: credentials[field["name"]].present?
        }
      end
    end

    # Nunca exponer las credenciales reales por seguridad
    # Solo indicar si están configuradas
    expose :has_credentials do |instance|
      instance.credentials.present?
    end

    # Estadísticas
    expose :vehicles_count, if: ->(instance, options) { options[:include_stats] } do |instance|
      instance.vehicles.count
    end

    expose :active_vehicles_count, if: ->(instance, options) { options[:include_stats] } do |instance|
      instance.vehicle_telemetry_configs.active.count
    end
  end
end
# app/api/entities/telemetry_normalization_error_entity.rb
module Entities
  class TelemetryNormalizationErrorEntity < Grape::Entity
    expose :id
    expose :telemetry_sync_log_id
    expose :error_type
    expose :error_message
    expose :provider_name
    expose :data_type
    expose :resolved
    expose :resolved_at
    expose :resolution_notes
    expose :created_at

    # Raw data solo para admins o vista detallada
    expose :raw_data, if: ->(instance, options) { options[:admin_view] || options[:detailed] }

    # Relaciones
    expose :sync_log, using: TelemetrySyncLogEntity, if: ->(instance, options) { options[:include_sync_log] }
  end
end
# app/api/entities/telemetry_provider_entity.rb
module Entities
  class TelemetryProviderEntity < Grape::Entity
    expose :id
    expose :name
    expose :slug
    expose :description
    expose :is_active
    expose :created_at
    expose :updated_at

    # Exponer solo en vistas detalladas

    expose :api_base_url, if: ->(instance, options) { options[:detailed] }
    expose :configuration_schema, if: ->(instance, options) { options[:detailed] }
  end
end
# app/api/entities/telemetry_sync_log_entity.rb
module Entities
  class TelemetrySyncLogEntity < Grape::Entity
    expose :id
    expose :telemetry_credential_id
    expose :vehicle_id
    expose :sync_type
    expose :status
    expose :records_processed
    expose :records_created
    expose :records_updated
    expose :records_skipped
    expose :error_message
    expose :started_at
    expose :completed_at
    expose :created_at

    # Métricas
    expose :duration_seconds do |instance|
      instance.duration_seconds
    end

    expose :success_rate_percent do |instance|
      instance.success_rate_percent
    end

    expose :has_errors do |instance|
      instance.has_errors?
    end

    expose :error_count do |instance|
      instance.error_count
    end

    # Relaciones
    expose :telemetry_credential, using: TelemetryCredentialEntity, if: ->(instance, options) { options[:include_credential] }
    expose :vehicle, using: VehicleEntity, if: ->(instance, options) { options[:include_vehicle] }
    expose :errors, using: TelemetryNormalizationErrorEntity, if: ->(instance, options) { options[:include_errors] }

    # Error details solo para admins
    expose :error_details, if: ->(instance, options) { options[:admin_view] }
  end
end
# app/api/entities/vehicle_entity.rb
module Entities
  class VehicleEntity < Grape::Entity
    expose :id
    expose :company_id
    expose :name
    expose :license_plate
    expose :vin
    expose :brand
    expose :model
    expose :year
    expose :fuel_type # combustion, electric, hybrid
    expose :tank_capacity_liters
    expose :battery_capacity_kwh
    expose :is_active
    expose :created_at
    expose :updated_at

    # Telemetría
    expose :has_telemetry do |instance|
      instance.vehicle_telemetry_config.present?
    end

    expose :telemetry_provider, if: ->(instance, options) { instance.vehicle_telemetry_config.present? } do |instance|
      instance.vehicle_telemetry_config&.provider_name
    end

    # Relaciones opcionales
    expose :company, using: CompanyEntity, if: ->(instance, options) { options[:include_company] }
    expose :telemetry_config, using: VehicleTelemetryConfigEntity, if: ->(instance, options) { options[:include_telemetry_config] }

    # Estadísticas opcionales
    expose :stats, if: ->(instance, options) { options[:include_stats] } do
      expose :total_refuels do |instance|
        instance.refuels.count
      end

      expose :total_charges do |instance|
        instance.electric_charges.count
      end

      expose :last_refuel_date do |instance|
        instance.refuels.maximum(:refuel_date)
      end

      expose :last_charge_date do |instance|
        instance.electric_charges.maximum(:start_time)
      end
    end
  end
end
# app/api/entities/vehicle_telemetry_config_entity.rb
module Entities
  class VehicleTelemetryConfigEntity < Grape::Entity
    expose :id
    expose :vehicle_id
    expose :telemetry_credential_id
    expose :external_device_id
    expose :sync_frequency
    expose :data_types
    expose :is_active
    expose :last_sync_at
    expose :created_at
    expose :updated_at

    # Información del proveedor
    expose :provider_name do |instance|
      instance.provider_name
    end

    # Relaciones opcionales
    expose :vehicle, using: VehicleEntity, if: ->(instance, options) { options[:include_vehicle] }
    expose :telemetry_credential, using: TelemetryCredentialEntity, if: ->(instance, options) { options[:include_credential] }

    # Helpers
    expose :syncs_refuels do |instance|
      instance.sync_refuels?
    end

    expose :syncs_charges do |instance|
      instance.sync_charges?
    end

    expose :syncs_odometer do |instance|
      instance.sync_odometer?
    end
  end
end
