# app/api/v1/telemetry_credentials_api.rb
module V1
  class TelemetryCredentialsApi < Grape::API
    version "v1", using: :path
    format :json
    prefix :api

    helpers do
      def current_company
        Company.find(params[:company_id]) if params[:company_id]
      end

      def authorize_company!
        error!("Company not found", 404) unless current_company
      end
    end

    resource :companies do
      route_param :company_id do
        resource :telemetry_credentials do
          desc "List company telemetry credentials",
               success: Entities::TelemetryCredentialEntity,
               is_array: true,
               tags: [ "Telemetry Credentials" ]
          params do
            optional :provider_slug, type: String, desc: "Filter by provider"
            optional :active_only, type: Boolean, default: false
          end
          get do
            authorize_company!

            credentials = current_company.telemetry_credentials
            credentials = credentials.for_provider(params[:provider_slug]) if params[:provider_slug]
            credentials = credentials.active if params[:active_only]

            present credentials, with: Entities::TelemetryCredentialEntity, include_provider: true, include_stats: true
          end

          desc "Create telemetry credentials",
               success: Entities::TelemetryCredentialEntity,
               tags: [ "Telemetry Credentials" ]
          params do
            requires :telemetry_provider_id, type: Integer, desc: "Provider ID"
            requires :credentials, type: Hash, desc: "Provider credentials" do
              optional :userName, type: String
              optional :password, type: String
              optional :database, type: String
              optional :apiKey, type: String
              optional :apiToken, type: String
            end
          end
          post do
            authorize_company!

            provider = TelemetryProvider.find(params[:telemetry_provider_id])

            # Verificar que no exista ya una credencial para este proveedor
            existing = current_company.telemetry_credentials.find_by(telemetry_provider_id: provider.id)
            error!("Credentials already exist for this provider", 422) if existing

            credential = TelemetryCredential.new(
              company: current_company,
              telemetry_provider: provider,
              credentials: params[:credentials].to_json,
              is_active: true
            )

            if credential.save
              present credential, with: Entities::TelemetryCredentialEntity, include_provider: true
            else
              error!(credential.errors.full_messages, 422)
            end
          end

          desc "Update telemetry credentials",
               success: Entities::TelemetryCredentialEntity,
               tags: [ "Telemetry Credentials" ]
          params do
            requires :id, type: Integer, desc: "Credential ID"
            optional :credentials, type: Hash, desc: "Updated credentials"
            optional :is_active, type: Boolean, desc: "Active status"
          end
          route_param :id do
            put do
              authorize_company!

              credential = current_company.telemetry_credentials.find(params[:id])

              update_params = {}
              update_params[:credentials] = params[:credentials].to_json if params[:credentials]
              update_params[:is_active] = params[:is_active] if params.key?(:is_active)

              if credential.update(update_params)
                present credential, with: Entities::TelemetryCredentialEntity, include_provider: true
              else
                error!(credential.errors.full_messages, 422)
              end
            end

            desc "Delete telemetry credentials",
                 tags: [ "Telemetry Credentials" ]
            delete do
              authorize_company!

              credential = current_company.telemetry_credentials.find(params[:id])
              credential.destroy

              { success: true, message: "Credentials deleted successfully" }
            end

            desc "Test telemetry credentials connection",
                 tags: [ "Telemetry Credentials" ]
            post :test do
              authorize_company!

              credential = current_company.telemetry_credentials.find(params[:id])

              case credential.provider_name
              when "geotab"
                connector = Telemetry::Connectors::GeotabConnector.new(credential.credentials_hash)
                session_id = connector.authenticate!

                {
                  success: true,
                  message: "Connection successful",
                  session_id: session_id
                }
              else
                error!("Provider not supported for testing", 422)
              end

            rescue Telemetry::Connectors::GeotabConnector::AuthenticationError => e
              { success: false, message: "Authentication failed: #{e.message}" }
            rescue StandardError => e
              { success: false, message: "Connection error: #{e.message}" }
            end
          end
        end
      end
    end
  end
end
# app/api/v1/telemetry_providers_api.rb
module V1
  class TelemetryProvidersApi < Grape::API
    version "v1", using: :path
    format :json
    prefix :api

    helpers do
      def current_company
        # Implementar según tu sistema de autenticación
        # Por ejemplo: @current_user.company
        Company.find(params[:company_id]) if params[:company_id]
      end
    end

    resource :telemetry_providers do
      desc "List all available telemetry providers",
           success: Entities::TelemetryProviderEntity,
           is_array: true,
           tags: [ "Telemetry Providers" ]
      params do
        optional :active_only, type: Boolean, default: true, desc: "Filter only active providers"
      end
      get do
        providers = params[:active_only] ? TelemetryProvider.active : TelemetryProvider.all
        present providers, with: Entities::TelemetryProviderEntity
      end

      desc "Get a specific telemetry provider",
           success: Entities::TelemetryProviderEntity,
           tags: [ "Telemetry Providers" ]
      params do
        requires :id, type: Integer, desc: "Provider ID"
      end
      route_param :id do
        get do
          provider = TelemetryProvider.find(params[:id])
          present provider, with: Entities::TelemetryProviderEntity, detailed: true
        end
      end

      desc "Get provider by slug",
           success: Entities::TelemetryProviderEntity,
           tags: [ "Telemetry Providers" ]
      params do
        requires :slug, type: String, desc: "Provider slug (e.g., geotab)"
      end
      get ":slug/details" do
        provider = TelemetryProvider.find_by_slug!(params[:slug])
        present provider, with: Entities::TelemetryProviderEntity, detailed: true
      end
    end
  end
end
# app/api/v1/telemetry_sync_api.rb
module V1
  class TelemetrySyncApi < Grape::API
    version "v1", using: :path
    format :json
    prefix :api

    helpers do
      def current_company
        Company.find(params[:company_id]) if params[:company_id]
      end

      def authorize_company!
        error!("Company not found", 404) unless current_company
      end

      def find_credential!
        credential = current_company.telemetry_credentials.find(params[:credential_id])
        error!("Credential not active", 422) unless credential.is_active?
        credential
      end
    end

    resource :companies do
      route_param :company_id do
        resource :telemetry_credentials do
          route_param :credential_id do
            namespace :sync do
              desc "Sync refuels (fuel fill-ups)",
                   tags: [ "Telemetry Sync" ]
              params do
                optional :from_date, type: DateTime, desc: "Start date for sync"
                optional :to_date, type: DateTime, desc: "End date for sync"
                optional :vehicle_id, type: Integer, desc: "Sync specific vehicle only"
              end
              post :refuels do
                authorize_company!
                credential = find_credential!

                sync_service = Telemetry::SyncService.new(credential)
                result = sync_service.sync_refuels(
                  vehicle_id: params[:vehicle_id],
                  from_date: params[:from_date],
                  to_date: params[:to_date]
                )

                {
                  success: result[:success],
                  sync_log_id: result[:sync_log_id],
                  stats: result[:stats],
                  error: result[:error]
                }
              end

              desc "Sync electric charges",
                   tags: [ "Telemetry Sync" ]
              params do
                optional :from_date, type: DateTime, desc: "Start date for sync"
                optional :to_date, type: DateTime, desc: "End date for sync"
                optional :vehicle_id, type: Integer, desc: "Sync specific vehicle only"
              end
              post :charges do
                authorize_company!
                credential = find_credential!

                sync_service = Telemetry::SyncService.new(credential)
                result = sync_service.sync_charges(
                  vehicle_id: params[:vehicle_id],
                  from_date: params[:from_date],
                  to_date: params[:to_date]
                )

                {
                  success: result[:success],
                  sync_log_id: result[:sync_log_id],
                  stats: result[:stats],
                  error: result[:error]
                }
              end

              desc "Sync all data types",
                   tags: [ "Telemetry Sync" ]
              params do
                optional :from_date, type: DateTime, desc: "Start date for sync"
                optional :to_date, type: DateTime, desc: "End date for sync"
              end
              post :all do
                authorize_company!
                credential = find_credential!

                sync_service = Telemetry::SyncService.new(credential)
                results = sync_service.sync_all(
                  from_date: params[:from_date],
                  to_date: params[:to_date]
                )

                {
                  success: true,
                  results: results
                }
              end

              desc "Get sync logs",
                   success: Entities::TelemetrySyncLogEntity,
                   is_array: true,
                   tags: [ "Telemetry Sync" ]
              params do
                optional :sync_type, type: String, desc: "Filter by sync type"
                optional :status, type: String, desc: "Filter by status"
                optional :page, type: Integer, default: 1
                optional :per_page, type: Integer, default: 20
              end
              get :logs do
                authorize_company!
                credential = find_credential!

                logs = credential.telemetry_sync_logs.recent
                logs = logs.for_sync_type(params[:sync_type]) if params[:sync_type]
                logs = logs.where(status: params[:status]) if params[:status]

                logs = logs.page(params[:page]).per(params[:per_page])

                present logs, with: Entities::TelemetrySyncLogEntity
              end

              desc "Get specific sync log details",
                   success: Entities::TelemetrySyncLogEntity,
                   tags: [ "Telemetry Sync" ]
              params do
                requires :log_id, type: Integer, desc: "Sync log ID"
              end
              get "logs/:log_id" do
                authorize_company!
                credential = find_credential!

                log = credential.telemetry_sync_logs.find(params[:log_id])
                present log, with: Entities::TelemetrySyncLogEntity,
                        include_errors: true,
                        admin_view: true
              end
            end
          end
        end
      end
    end
  end
end
# app/api/v1/vehicle_telemetry_api.rb
module V1
  class VehicleTelemetryApi < Grape::API
    version "v1", using: :path
    format :json
    prefix :api

    helpers do
      def current_company
        Company.find(params[:company_id]) if params[:company_id]
      end

      def authorize_company!
        error!("Company not found", 404) unless current_company
      end

      def find_vehicle!
        vehicle = current_company.vehicles.find(params[:vehicle_id])
        error!("Vehicle not found", 404) unless vehicle
        vehicle
      end
    end

    resource :companies do
      route_param :company_id do
        resource :vehicles do
          route_param :vehicle_id do
            # Configuración de telemetría del vehículo
            namespace :telemetry_config do
              desc "Get vehicle telemetry configuration",
                   success: Entities::VehicleTelemetryConfigEntity,
                   tags: [ "Vehicle Telemetry" ]
              get do
                authorize_company!
                vehicle = find_vehicle!

                config = vehicle.vehicle_telemetry_config
                error!("No telemetry configuration found", 404) unless config

                present config, with: Entities::VehicleTelemetryConfigEntity, include_credential: true
              end

              desc "Create or update vehicle telemetry configuration",
                   success: Entities::VehicleTelemetryConfigEntity,
                   tags: [ "Vehicle Telemetry" ]
              params do
                requires :telemetry_credential_id, type: Integer, desc: "Credential ID"
                requires :external_device_id, type: String, desc: "Device ID in provider system"
                optional :sync_frequency, type: String, values: %w[manual hourly daily weekly], default: "daily"
                optional :data_types, type: Array[String], default: %w[refuels charges odometer]
                optional :is_active, type: Boolean, default: true
              end
              post do
                authorize_company!
                vehicle = find_vehicle!

                # Verificar que la credencial pertenece a la empresa
                credential = current_company.telemetry_credentials.find(params[:telemetry_credential_id])

                config = vehicle.vehicle_telemetry_config || vehicle.build_vehicle_telemetry_config

                config.assign_attributes(
                  telemetry_credential_id: credential.id,
                  external_device_id: params[:external_device_id],
                  sync_frequency: params[:sync_frequency],
                  data_types: params[:data_types],
                  is_active: params[:is_active]
                )

                if config.save
                  present config, with: Entities::VehicleTelemetryConfigEntity, include_credential: true
                else
                  error!(config.errors.full_messages, 422)
                end
              end

              desc "Delete vehicle telemetry configuration",
                   tags: [ "Vehicle Telemetry" ]
              delete do
                authorize_company!
                vehicle = find_vehicle!

                config = vehicle.vehicle_telemetry_config
                error!("No configuration to delete", 404) unless config

                config.destroy
                { success: true, message: "Configuration deleted" }
              end
            end

            # Datos de repostajes
            namespace :refuels do
              desc "Get vehicle refuels",
                   success: Entities::RefuelEntity,
                   is_array: true,
                   tags: [ "Vehicle Telemetry" ]
              params do
                optional :from_date, type: Date, desc: "Filter from date"
                optional :to_date, type: Date, desc: "Filter to date"
                optional :page, type: Integer, default: 1
                optional :per_page, type: Integer, default: 50
                optional :include_calculations, type: Boolean, default: false
                optional :include_anomalies, type: Boolean, default: false
              end
              get do
                authorize_company!
                vehicle = find_vehicle!

                refuels = vehicle.refuels.recent
                refuels = refuels.in_date_range(params[:from_date], params[:to_date]) if params[:from_date] && params[:to_date]
                refuels = refuels.page(params[:page]).per(params[:per_page])

                present refuels, with: Entities::RefuelEntity,
                        include_calculations: params[:include_calculations],
                        include_anomalies: params[:include_anomalies]
              end

              desc "Get refuel statistics",
                   tags: [ "Vehicle Telemetry" ]
              params do
                optional :from_date, type: Date, desc: "Filter from date"
                optional :to_date, type: Date, desc: "Filter to date"
              end
              get :stats do
                authorize_company!
                vehicle = find_vehicle!

                refuels = vehicle.refuels
                refuels = refuels.in_date_range(params[:from_date], params[:to_date]) if params[:from_date] && params[:to_date]

                {
                  total_refuels: refuels.count,
                  total_liters: refuels.sum(:volume_liters).round(2),
                  total_cost: refuels.sum(:cost).round(2),
                  average_volume: refuels.average(:volume_liters)&.round(2),
                  average_cost: refuels.average(:cost)&.round(2),
                  anomalies_count: refuels.select { |r| r.exceeds_tank_capacity? }.count
                }
              end
            end

            # Datos de cargas eléctricas
            namespace :charges do
              desc "Get vehicle electric charges",
                   success: Entities::ElectricChargeEntity,
                   is_array: true,
                   tags: [ "Vehicle Telemetry" ]
              params do
                optional :from_date, type: Date, desc: "Filter from date"
                optional :to_date, type: Date, desc: "Filter to date"
                optional :charge_type, type: String, values: %w[AC DC], desc: "Filter by charge type"
                optional :page, type: Integer, default: 1
                optional :per_page, type: Integer, default: 50
                optional :include_calculations, type: Boolean, default: false
                optional :include_anomalies, type: Boolean, default: false
              end
              get do
                authorize_company!
                vehicle = find_vehicle!

                charges = vehicle.electric_charges.recent
                charges = charges.in_date_range(params[:from_date], params[:to_date]) if params[:from_date] && params[:to_date]
                charges = charges.where(charge_type: params[:charge_type]) if params[:charge_type]
                charges = charges.page(params[:page]).per(params[:per_page])

                present charges, with: Entities::ElectricChargeEntity,
                        include_calculations: params[:include_calculations],
                        include_anomalies: params[:include_anomalies]
              end

              desc "Get charge statistics",
                   tags: [ "Vehicle Telemetry" ]
              params do
                optional :from_date, type: Date, desc: "Filter from date"
                optional :to_date, type: Date, desc: "Filter to date"
              end
              get :stats do
                authorize_company!
                vehicle = find_vehicle!

                charges = vehicle.electric_charges
                charges = charges.in_date_range(params[:from_date], params[:to_date]) if params[:from_date] && params[:to_date]

                {
                  total_charges: charges.count,
                  total_kwh: charges.sum(:energy_consumed_kwh).round(3),
                  total_duration_minutes: charges.sum(:duration_minutes),
                  average_kwh: charges.average(:energy_consumed_kwh)&.round(3),
                  average_duration_minutes: charges.average(:duration_minutes)&.round(2),
                  ac_charges: charges.ac_charges.count,
                  dc_charges: charges.dc_charges.count
                }
              end
            end
          end
        end
      end
    end
  end
end
# app/api/v1/vehicles_api.rb
module V1
  class VehiclesApi < Grape::API
    version "v1", using: :path
    format :json
    prefix :api

    helpers do
      def current_company
        Company.find(params[:company_id]) if params[:company_id]
      end

      def authorize_company!
        error!("Company not found", 404) unless current_company
      end
    end

    resource :companies do
      route_param :company_id do
        resource :vehicles do
          desc "List company vehicles",
               success: Entities::VehicleEntity,
               is_array: true,
               tags: [ "Vehicles" ]
          params do
            optional :active_only, type: Boolean, default: false
            optional :fuel_type, type: String, values: %w[combustion electric hybrid]
            optional :with_telemetry, type: Boolean, default: false
            optional :page, type: Integer, default: 1
            optional :per_page, type: Integer, default: 20
            optional :include_stats, type: Boolean, default: false
          end
          get do
            authorize_company!

            vehicles = current_company.vehicles
            vehicles = vehicles.active if params[:active_only]
            vehicles = vehicles.where(fuel_type: params[:fuel_type]) if params[:fuel_type]
            vehicles = vehicles.with_telemetry if params[:with_telemetry]

            vehicles = vehicles.page(params[:page]).per(params[:per_page])

            present vehicles, with: Entities::VehicleEntity, include_stats: params[:include_stats]
          end

          desc "Get vehicle details",
               success: Entities::VehicleEntity,
               tags: [ "Vehicles" ]
          params do
            requires :id, type: Integer, desc: "Vehicle ID"
            optional :include_telemetry_config, type: Boolean, default: false
            optional :include_stats, type: Boolean, default: false
          end
          route_param :id do
            get do
              authorize_company!

              vehicle = current_company.vehicles.find(params[:id])
              present vehicle, with: Entities::VehicleEntity,
                      include_telemetry_config: params[:include_telemetry_config],
                      include_stats: params[:include_stats]
            end
          end

          desc "Create a new vehicle",
               success: Entities::VehicleEntity,
               tags: [ "Vehicles" ]
          params do
            requires :name, type: String, desc: "Vehicle name"
            requires :license_plate, type: String, desc: "License plate"
            optional :vin, type: String, desc: "VIN"
            optional :brand, type: String, desc: "Brand"
            optional :model, type: String, desc: "Model"
            optional :year, type: Integer, desc: "Year"
            optional :fuel_type, type: String, values: %w[combustion electric hybrid]
            optional :tank_capacity_liters, type: Float, desc: "Tank capacity in liters"
            optional :battery_capacity_kwh, type: Float, desc: "Battery capacity in kWh"
            optional :is_active, type: Boolean, default: true
          end
          post do
            authorize_company!

            vehicle = current_company.vehicles.new(
              name: params[:name],
              license_plate: params[:license_plate],
              vin: params[:vin],
              brand: params[:brand],
              model: params[:model],
              year: params[:year],
              fuel_type: params[:fuel_type],
              tank_capacity_liters: params[:tank_capacity_liters],
              battery_capacity_kwh: params[:battery_capacity_kwh],
              is_active: params[:is_active]
            )

            if vehicle.save
              present vehicle, with: Entities::VehicleEntity
            else
              error!(vehicle.errors.full_messages, 422)
            end
          end

          desc "Update a vehicle",
               success: Entities::VehicleEntity,
               tags: [ "Vehicles" ]
          params do
            requires :id, type: Integer, desc: "Vehicle ID"
            optional :name, type: String
            optional :license_plate, type: String
            optional :vin, type: String
            optional :brand, type: String
            optional :model, type: String
            optional :year, type: Integer
            optional :fuel_type, type: String, values: %w[combustion electric hybrid]
            optional :tank_capacity_liters, type: Float
            optional :battery_capacity_kwh, type: Float
            optional :is_active, type: Boolean
          end
          route_param :id do
            put do
              authorize_company!

              vehicle = current_company.vehicles.find(params[:id])

              update_params = declared(params, include_missing: false).except(:id, :company_id)

              if vehicle.update(update_params)
                present vehicle, with: Entities::VehicleEntity
              else
                error!(vehicle.errors.full_messages, 422)
              end
            end
          end

          desc "Delete a vehicle",
               tags: [ "Vehicles" ]
          params do
            requires :id, type: Integer, desc: "Vehicle ID"
          end
          route_param :id do
            delete do
              authorize_company!

              vehicle = current_company.vehicles.find(params[:id])

              if vehicle.destroy
                { success: true, message: "Vehicle deleted successfully" }
              else
                error!(vehicle.errors.full_messages, 422)
              end
            end
          end

          desc "Get vehicles without telemetry configuration",
               success: Entities::VehicleEntity,
               is_array: true,
               tags: [ "Vehicles" ]
          params do
            optional :page, type: Integer, default: 1
            optional :per_page, type: Integer, default: 20
          end
          get :without_telemetry do
            authorize_company!

            vehicles = current_company.vehicles_without_telemetry
            vehicles = vehicles.page(params[:page]).per(params[:per_page])

            present vehicles, with: Entities::VehicleEntity
          end

          desc "Get vehicles with active telemetry",
               success: Entities::VehicleEntity,
               is_array: true,
               tags: [ "Vehicles" ]
          params do
            optional :page, type: Integer, default: 1
            optional :per_page, type: Integer, default: 20
          end
          get :with_telemetry do
            authorize_company!

            vehicles = current_company.vehicles_with_telemetry
            vehicles = vehicles.page(params[:page]).per(params[:per_page])

            present vehicles, with: Entities::VehicleEntity, include_telemetry_config: true
          end
        end
      end
    end
  end
end
