# db/migrate/create_integration_categories.rb
class CreateIntegrationCategories < ActiveRecord::Migration[7.0]
  def change
    create_table :integration_categories do |t|
      t.string :name, null: false, limit: 100
      t.string :slug, null: false, limit: 50
      t.text :description
      t.string :icon, limit: 50
      t.integer :display_order, default: 999, null: false
      t.boolean :is_active, default: true, null: false

      t.timestamps
    end

    add_index :integration_categories, :slug, unique: true
    add_index :integration_categories, :is_active
    add_index :integration_categories, :display_order
  end
end

# db/migrate/create_integration_providers.rb
class CreateIntegrationProviders < ActiveRecord::Migration[7.0]
  def change
    create_table :integration_providers do |t|
      t.references :integration_category, null: false, foreign_key: true, index: true

      t.string :name, null: false, limit: 100
      t.string :slug, null: false, limit: 50
      t.string :api_base_url, limit: 500
      t.text :description
      t.string :logo_url, limit: 500
      t.string :website_url, limit: 500
      t.string :status, limit: 20, default: 'active', null: false
      t.boolean :is_premium, default: false, null: false
      t.integer :display_order, default: 999, null: false
      t.boolean :is_active, default: true, null: false

      t.timestamps
    end

    add_index :integration_providers, :slug, unique: true
    add_index :integration_providers, :status
    add_index :integration_providers, :is_active
    add_index :integration_providers, :is_premium
    add_index :integration_providers, :display_order
  end
end

# db/migrate/create_integration_auth_schemas.rb
class CreateIntegrationAuthSchemas < ActiveRecord::Migration[7.0]
  def change
    create_table :integration_auth_schemas do |t|
      t.references :integration_provider, null: false, foreign_key: true

      t.jsonb :auth_fields, null: false, default: {}
      t.jsonb :example_credentials, default: {}
      t.boolean :is_active, default: true, null: false

      t.timestamps
    end
    add_index :integration_auth_schemas, :integration_provider_id,
              unique: true,
              where: "is_active = true",
              name: 'idx_auth_schemas_active_provider'

    add_index :integration_auth_schemas, :is_active
  end
end

# db/migrate/create_integration_features.rb
class CreateIntegrationFeatures < ActiveRecord::Migration[7.0]
  def change
    create_table :integration_features do |t|
      t.references :integration_provider, null: false, foreign_key: true, index: true

      t.string :feature_key, null: false, limit: 50
      t.string :feature_name, null: false, limit: 100
      t.text :feature_description
      t.integer :display_order, default: 999, null: false
      t.boolean :is_active, default: true, null: false

      t.timestamps
    end

    add_index :integration_features, [ :integration_provider_id, :feature_key ],
              unique: true,
              name: 'idx_features_provider_key'

    add_index :integration_features, :feature_key
    add_index :integration_features, :is_active
    add_index :integration_features, :display_order
  end
end

# db/migrate/create_tenants.rb
class CreateTenants < ActiveRecord::Migration[7.0]
  def change
    create_table :tenants do |t|
      t.string :name, null: false, limit: 255
      t.string :slug, null: false, limit: 100
      t.string :email, limit: 255
      t.string :status, null: false, limit: 20, default: 'active'
      t.jsonb :settings, null: false, default: {}

      t.timestamps
    end
    add_index :tenants, :slug, unique: true
    add_index :tenants, :status
    add_index :tenants, :created_at
  end
end

class CreateTenantIntegrationConfigurations < ActiveRecord::Migration[7.0]
  def change
    create_table :tenant_integration_configurations do |t|
      t.references :tenant, null: false, foreign_key: true, index: false
      t.references :integration_provider, null: false, foreign_key: true, index: false
      t.jsonb :credentials
      t.boolean :is_active, default: false, null: false
      t.datetime :activated_at
      t.string :sync_frequency, null: false, limit: 20, default: 'daily'
      t.integer :sync_hour, null: false, default: 2
      t.integer :sync_day_of_week
      t.string :sync_day_of_month, limit: 20
      t.jsonb :enabled_features, null: false, default: []
      t.jsonb :sync_config, null: false, default: {}
      t.datetime :last_sync_at
      t.string :last_sync_status, limit: 20
      t.text :last_sync_error
      t.jsonb :metadata, null: false, default: {}
      t.timestamps
    end
    add_index :tenant_integration_configurations,
              [ :tenant_id, :integration_provider_id ],
              unique: true,
              name: 'idx_tenant_provider_unique'
    add_index :tenant_integration_configurations, :tenant_id, name: 'idx_tenant_config_tenant'
    add_index :tenant_integration_configurations, :integration_provider_id, name: 'idx_tenant_config_provider'
    add_index :tenant_integration_configurations, :is_active
    add_index :tenant_integration_configurations, :sync_frequency
    add_index :tenant_integration_configurations, :sync_hour
    add_index :tenant_integration_configurations, :sync_day_of_week
    add_index :tenant_integration_configurations, :last_sync_at
    add_index :tenant_integration_configurations, :last_sync_status
  end
end

# db/migrate/create_integration_sync_executions.rb
class CreateIntegrationSyncExecutions < ActiveRecord::Migration[7.0]
  def change
    create_table :integration_sync_executions do |t|
      t.references :tenant_integration_configuration,
                   null: false,
                   foreign_key: true,
                   index: { name: 'idx_sync_exec_config' }
      t.string :feature_key, null: false, limit: 50
      t.string :trigger_type, null: false, limit: 20, default: 'manual'
      t.string :status, null: false, limit: 20, default: 'running'
      t.datetime :started_at, null: false
      t.datetime :finished_at
      t.integer :duration_seconds
      t.integer :records_fetched, default: 0, null: false
      t.integer :records_processed, default: 0, null: false
      t.integer :records_failed, default: 0, null: false
      t.integer :records_skipped, default: 0, null: false
      t.text :error_message
      t.jsonb :metadata, default: {}, null: false
      t.timestamps
    end
    add_index :integration_sync_executions, :feature_key
    add_index :integration_sync_executions, :status
    add_index :integration_sync_executions, :trigger_type
    add_index :integration_sync_executions, :started_at
    add_index :integration_sync_executions,
              [ :tenant_integration_configuration_id, :started_at ],
              name: 'idx_sync_exec_config_date'
  end
end
# db/migrate/YYYYMMDDHHMMSS_create_integration_raw_data.rb
class CreateIntegrationRawData < ActiveRecord::Migration[7.0]
  def change
    create_table :integration_raw_data do |t|
      t.references :integration_sync_execution,
                   null: false,
                   foreign_key: true,
                   index: { name: 'idx_raw_data_execution' }
      t.references :tenant_integration_configuration,
                   null: false,
                   foreign_key: true,
                   index: { name: 'idx_raw_data_config' }
      t.string :provider_slug, null: false, limit: 50
      t.string :feature_key, null: false, limit: 50
      t.string :external_id, null: false, limit: 255
      t.jsonb :raw_data, null: false
      t.string :processing_status, null: false, limit: 20, default: 'pending'
      t.string :normalized_record_type, limit: 50
      t.bigint :normalized_record_id
      t.text :normalization_error
      t.datetime :normalized_at
      t.jsonb :metadata, default: {}, null: false
      t.datetime :last_retry_at
      t.datetime :deleted_at
      t.integer :retry_count, :integer, default: 0, null: false
      t.timestamps
    end
    add_index :integration_raw_data,
              [ :tenant_integration_configuration_id, :provider_slug, :feature_key, :external_id ],
              unique: true,
              name: 'idx_raw_data_unique'
    add_index :integration_raw_data, :processing_status
    add_index :integration_raw_data, :external_id
    add_index :integration_raw_data,
              [ :normalized_record_type, :normalized_record_id ],
              name: 'idx_raw_data_normalized'
    add_index :integration_raw_data,
              [ :integration_sync_execution_id, :processing_status ],
              name: 'idx_raw_data_exec_status'
    add_index :integration_raw_data, :metadata, using: :gin
        add_index :integration_raw_data, :retry_count
    add_index :integration_raw_data, :last_retry_at
    add_index :integration_raw_data, :deleted_at
    add_index :integration_raw_data,
              [ :tenant_integration_configuration_id, :processing_status, :created_at ],
              name: 'idx_raw_data_config_status_date'
     add_index :integration_raw_data,
              [ :tenant_integration_configuration_id, :external_id, :feature_key ],
              name: 'idx_raw_data_config_external_feature',
              unique: true,
              where: "deleted_at IS NULL"
  end
end

# db/migrate/create_vehicles.rb
class CreateVehicles < ActiveRecord::Migration[7.0]
  def change
    create_table :vehicles do |t|
      t.references :tenant, null: false, foreign_key: true, index: true
      t.string :name, null: false, limit: 255
       t.string :license_plate, null: false, limit: 20
      t.string :vin, limit: 17
      t.string :brand, limit: 100
      t.string :model, limit: 100
      t.integer :year
      t.string :vehicle_type, limit: 50
      t.string :fuel_type, limit: 50
      t.boolean :is_electric, default: false, null: false
      t.decimal :tank_capacity_liters, precision: 10, scale: 2
      t.decimal :battery_capacity_kwh, precision: 10, scale: 2
      t.decimal :initial_odometer_km, precision: 12, scale: 2
      t.decimal :current_odometer_km, precision: 12, scale: 2
      t.string :status, null: false, limit: 20, default: 'active'
      t.date :acquisition_date
      t.date :last_maintenance_date
      t.date :next_maintenance_date
      t.jsonb :metadata, default: {}, null: false
      t.timestamps
    end
    add_index :vehicles, [ :tenant_id, :license_plate ], unique: true, name: 'idx_vehicles_tenant_plate'
    add_index :vehicles, :vin, unique: true, where: "vin IS NOT NULL"
    add_index :vehicles, :status
    add_index :vehicles, :is_electric
    add_index :vehicles, :fuel_type
    add_index :vehicles, :vehicle_type
    add_index :vehicles, [ :tenant_id, :status ], name: 'idx_vehicles_tenant_status'
  end
end

# db/migrate/create_vehicle_electric_charges.rb
class CreateVehicleElectricCharges < ActiveRecord::Migration[7.0]
  def change
    create_table :vehicle_electric_charges do |t|
      t.references :tenant, null: false, foreign_key: true, index: true
      t.references :vehicle, null: false, foreign_key: true, index: true
      t.references :integration_raw_data,
                   foreign_key: true,
                   index: { unique: true, name: 'idx_charges_raw_unique' }
      t.datetime :charge_start_time, null: false
      t.datetime :charge_end_time
      t.integer :duration_minutes
      t.decimal :location_lat, precision: 10, scale: 8
      t.decimal :location_lng, precision: 11, scale: 8
      t.string :charge_type, limit: 10
      t.decimal :start_soc_percent, precision: 5, scale: 2
      t.decimal :end_soc_percent, precision: 5, scale: 2
      t.decimal :energy_consumed_kwh, precision: 10, scale: 3
      t.decimal :peak_power_kw, precision: 10, scale: 3
      t.decimal :odometer_km, precision: 12, scale: 2
      t.boolean :is_estimated, default: false, null: false
      t.integer :max_ac_voltage
      t.jsonb :provider_metadata, default: {}, null: false
      t.timestamps
    end
    add_index :vehicle_electric_charges, :charge_start_time
    add_index :vehicle_electric_charges, [ :tenant_id, :charge_start_time ], name: 'idx_charges_tenant_date'
    add_index :vehicle_electric_charges, [ :vehicle_id, :charge_start_time ], name: 'idx_charges_vehicle_date'
    add_index :vehicle_electric_charges, :charge_type
    add_index :vehicle_electric_charges, :is_estimated
  end
end

# db/migrate/create_vehicle_refuelings.rb
class CreateVehicleRefuelings < ActiveRecord::Migration[7.0]
  def change
    create_table :vehicle_refuelings do |t|
      t.references :tenant, null: false, foreign_key: true, index: true
      t.references :vehicle, null: false, foreign_key: true, index: true
      t.references :integration_raw_data,
                   foreign_key: true,
                   index: { unique: true, name: 'idx_refuelings_raw_unique' }
      t.datetime :refueling_date, null: false
      t.decimal :location_lat, precision: 10, scale: 8
      t.decimal :location_lng, precision: 11, scale: 8
      t.decimal :volume_liters, precision: 10, scale: 2, null: false
      t.decimal :cost, precision: 10, scale: 2
      t.string :currency, limit: 3
      t.decimal :odometer_km, precision: 12, scale: 2
      t.string :fuel_type, limit: 50
      t.string :confidence_level, limit: 100
      t.boolean :is_estimated, default: false, null: false
      t.decimal :tank_capacity_liters, precision: 10, scale: 2
      t.jsonb :provider_metadata, default: {}, null: false
      t.timestamps
    end
    add_index :vehicle_refuelings, :refueling_date
    add_index :vehicle_refuelings, [ :tenant_id, :refueling_date ], name: 'idx_refuelings_tenant_date'
    add_index :vehicle_refuelings, [ :vehicle_id, :refueling_date ], name: 'idx_refuelings_vehicle_date'
    add_index :vehicle_refuelings, :is_estimated
  end
end

# db/migrate/YYYYMMDDHHMMSS_create_vehicle_provider_mappings.rb
class CreateVehicleProviderMappings < ActiveRecord::Migration[7.0]
  def change
    create_table :vehicle_provider_mappings do |t|
      t.references :vehicle, null: false, foreign_key: true, index: true
      t.references :tenant_integration_configuration,
                   null: false,
                   foreign_key: true,
                   index: { name: 'idx_vpm_config' }
      t.string :external_vehicle_id, null: false, limit: 100
      t.string :external_vehicle_name, limit: 255
      t.boolean :is_active, default: true, null: false
      t.datetime :mapped_at
      t.datetime :last_sync_at
      t.jsonb :external_metadata, default: {}, null: false
      t.timestamps
    end
    add_index :vehicle_provider_mappings,
              [ :vehicle_id, :tenant_integration_configuration_id, :is_active ],
              unique: true,
              where: "is_active = true",
              name: 'idx_vpm_vehicle_config_active'
    add_index :vehicle_provider_mappings,
              [ :tenant_integration_configuration_id, :external_vehicle_id ],
              unique: true,
              name: 'idx_vpm_config_external'

    add_index :vehicle_provider_mappings, :external_vehicle_id
    add_index :vehicle_provider_mappings, :is_active
    add_index :vehicle_provider_mappings, :last_sync_at
  end
end
